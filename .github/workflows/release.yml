name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build
        run: |
          make build VERSION=${{ steps.get_version.outputs.version }}

      - name: Test binary
        run: |
          ./bin/auto-git -v

  release:
    needs: build
    runs-on: macos-latest
    steps:
      - name: Checkout auto-git
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: pig98/homebrew-tap
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Wait for GitHub source archive
        run: |
          echo "Waiting for GitHub to generate source archive..."
          VERSION="${{ steps.get_version.outputs.version }}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"
          
          # Wait up to 60 seconds for GitHub to generate the archive
          for i in {1..12}; do
            if curl -sL -o /dev/null -w "%{http_code}" "$URL" | grep -q "200"; then
              echo "Source archive is available"
              break
            fi
            echo "Waiting for source archive... ($i/12)"
            sleep 5
          done

      - name: Calculate SHA256
        id: sha256
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"
          
          echo "Downloading source archive to calculate SHA256..."
          SHA256=$(curl -sL "$URL" | shasum -a 256 | awk '{print $1}')
          
          if [ -z "$SHA256" ]; then
            echo "Error: Failed to calculate SHA256. Source archive may not be available yet."
            exit 1
          fi
          
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"
          echo "Source archive URL: $URL"

      - name: Update Formula
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          FORMULA_FILE="homebrew-tap/Formula/auto-git.rb"
          
          # Create Formula file if it doesn't exist
          if [ ! -f "$FORMULA_FILE" ]; then
            mkdir -p "$(dirname "$FORMULA_FILE")"
            cp Formula/auto-git.rb "$FORMULA_FILE"
          fi
          
          # Update version, url, and sha256 (macOS sed requires backup extension)
          sed -i.bak \
            -e "s|version \"[^\"]*\"|version \"${VERSION}\"|g" \
            -e "s|url \"[^\"]*\"|url \"https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz\"|g" \
            -e "s|sha256 \"[^\"]*\"|sha256 \"${SHA256}\"|g" \
            "$FORMULA_FILE"
          
          # Remove backup file
          rm -f "$FORMULA_FILE.bak"
          
          echo "Formula updated:"
          cat "$FORMULA_FILE"

      - name: Commit and push to homebrew-tap
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Formula/auto-git.rb
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update auto-git to v${{ steps.get_version.outputs.version }}"
            git push origin main
            echo "Pushed to homebrew-tap"
          fi

